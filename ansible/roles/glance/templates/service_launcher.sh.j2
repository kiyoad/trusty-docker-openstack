#!/bin/bash
set -eux
# ---------------------------------------------------------------------------
# modify config file
# ---------------------------------------------------------------------------
crudini --set /etc/glance/glance-api.conf      DEFAULT debug True
crudini --set /etc/glance/glance-api.conf      database connection mysql://glance:{{ glance_db_password }}@${GLANCE_DATABASE_IP}/glance
crudini --set /etc/glance/glance-api.conf      keystone_authtoken auth_host ${KEYSTONE_IP}
crudini --set /etc/glance/glance-api.conf      keystone_authtoken admin_tenant_name service
crudini --set /etc/glance/glance-api.conf      keystone_authtoken admin_user glance
crudini --set /etc/glance/glance-api.conf      keystone_authtoken admin_password {{ glance_password }}
crudini --set /etc/glance/glance-api.conf      paste_deploy flavor keystone
crudini --set /etc/glance/glance-registry.conf DEFAULT debug True
crudini --set /etc/glance/glance-registry.conf database connection mysql://glance:{{ glance_db_password }}@${GLANCE_DATABASE_IP}/glance
crudini --set /etc/glance/glance-registry.conf keystone_authtoken auth_host ${KEYSTONE_IP}
crudini --set /etc/glance/glance-registry.conf keystone_authtoken admin_tenant_name service
crudini --set /etc/glance/glance-registry.conf keystone_authtoken admin_user glance
crudini --set /etc/glance/glance-registry.conf keystone_authtoken admin_password {{ glance_password }}
crudini --set /etc/glance/glance-registry.conf paste_deploy flavor keystone
# ---------------------------------------------------------------------------
# database initialization
# ---------------------------------------------------------------------------
if ! mysql -h ${GLANCE_DATABASE_IP} -uroot -p{{ database_root_password }} glance -e "show tables;" | grep -q glance ;
then
  sudo -u glance -g glance glance-manage db_sync
fi
# ---------------------------------------------------------------------------
# start service
# ---------------------------------------------------------------------------
start-stop-daemon --start --quiet --oknodo --pidfile /var/run/monit.pid --exec /usr/bin/monit -- -I -c /etc/monit/monitrc
